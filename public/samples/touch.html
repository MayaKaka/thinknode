<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
	<script src="../jquery/jquery-1.11.1.min.js"></script>
	<script src="../jquery/require.min.js"></script>
	<script src="../cartoon/excanvas.js"></script>
	<link rel="stylesheet" href="../jquery/bootstrap.min.css">
	<style>
	
		html {height:100%;}
		body {height:100%;background:#fff;color:#000;}
		#fps {position:absolute;z-index:200;left:0;top:0;color:#FF0;}
		.display { overflow: hidden; width: 100%; }
		.div-container, .cvs-container { float: left; border:#0E97E6 solid 1px; margin: 5px; position:relative; }
		.control {clear: both;}
		.control label { margin:5px 5px 0 8px; }
	</style>
</head>
<body>
	<div class="display">
		<div class="div-container"></div>
		<canvas class="cvs-container"></canvas>
	</div>
	
	<div class="control">
		<input type="button" value="blend-lighter" id="blend">
		<input type="button" value="blend-default" id="noBlend">
	</div>
<script>

	require.config({
		baseUrl: '../cartoon/',
		paths: {
			cartoon: 'cartoon'
		}
	});
	require(['cartoon'], function(ct){
		
		var divContainer = $('.div-container').cartoon({
			type: 'Container',
			size: { width: 600, height: 300 }
		});
		
		divContainer.$.css('overflow', 'hidden');
		
		var cvsContainer = $('.cvs-container').cartoon({
			type: 'Canvas',
			size: { width: 600, height: 300 }
		});
		
		var createShape = function(i, pos, color, transform, renderMode) {
			var shape = $.cartoon({
				type: 'Shape',
				renderMode: renderMode,
				pos: pos,
				transform: i%2===0? transform : {},
				graphics: i%2===0? {
					type: 'rect',
					width: 50, height: 50,
					fill: color
				}: {
					type: 'circle',
					radius: 25,
					fill: color
				}
			});
			shape.number = i;
			if (shape.$) {
				shape.$.css('text-align', 'center');
				shape.$.css('line-height', '28px');
			}
			
			var down = false, x = 0, y = 0, sx = 0, sy = 0;
			shape.on('mousedown', function(e) {
				down = true;
				x = this.x;
				y = this.y;
				sx = e.clientX;
				sy = e.clientY;
				console.log(sx, sy);
			});
			shape.on('mouseup', function(e) {
				down = false;
			});
			shape.on('mouseover', function(e) {
				down = false;
			});
			shape.on('mousemove', function(e) {
				if (!down) return;
				var dx = e.clientX - sx,
					dy = e.clientY - sy;

				this.style('pos', { x: x+dx, y: y+dy });
			});
			shape.on('click', function() {
				alert(this.number);
			});
			
			return shape;
		};
		var color, pos, transform;
		for(var i=0;i<20;i++) {
			pos = { x: Math.floor(Math.random()*600), y: Math.floor(Math.random()*300) };
			color = 'rgb('+Math.floor(Math.random()*256)+','+Math.floor(Math.random()*256)+','+Math.floor(Math.random()*256)+')';
			transform = { rotate: Math.floor(Math.random()*360) };
			
			divContainer.addChild(createShape(i, pos, color, transform, false));
			cvsContainer.addChild(createShape(i, pos, color, transform, true));			
		}
	
		
		var ticker = new ct.Ticker();
		ticker.add(cvsContainer);
		ticker.start();
		
		$('.control').bind('click', function(e) {
			var id = e.target.id,
				val = parseFloat(e.target.value);
			
			switch(id) {
				case 'blend':
					cvsContainer._children.forEach(function(a, i){
						a.blendMode = 'lighter';
					});
					break;
				case 'noBlend':
					cvsContainer._children.forEach(function(a, i){
						a.blendMode = 'source-over';
					});
					break;
				
			}
		});
	});
</script>
</body>
</html>